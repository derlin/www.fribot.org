!function(h){var e,u=wp.customize;u.Setting=u.Value.extend({initialize:function(e,t,i){u.Value.prototype.initialize.call(this,t,i),this.id=e,this.transport=this.transport||"refresh",this.bind(this.preview)},preview:function(){switch(this.transport){case"refresh":return this.previewer.refresh();case"postMessage":return this.previewer.send("setting",[this.id,this()])}}}),u.Control=u.Class.extend({initialize:function(e,t){var n,r,s=this;this.params={},h.extend(this,t||{}),this.id=e,this.selector="#customize-control-"+e.replace(/\]/g,"").replace(/\[/g,"-"),this.container=h(this.selector),this.active=new u.Value(this.params.active),e=h.map(this.params.settings,function(e){return e}),u.apply(u,e.concat(function(){for(var e in s.settings={},s.params.settings)s.settings[e]=u(s.params.settings[e]);s.setting=s.settings["default"]||null,s.ready()})),s.elements=[],n=this.container.find("[data-customize-setting-link]"),r={},n.each(function(){var e,i=h(this);if(i.is(":radio")){if(e=i.prop("name"),r[e])return;r[e]=!0,i=n.filter('[name="'+e+'"]')}u(i.data("customizeSettingLink"),function(e){var t=new u.Element(i);s.elements.push(t),t.sync(e),t.set(e())})}),s.active.bind(function(e){s.toggle(e)}),s.toggle(s.active())},ready:function(){},toggle:function(e){e?this.container.slideDown():this.container.slideUp()},dropdownInit:function(){function e(e){"string"==typeof e&&n.statuses&&n.statuses[e]?i.html(n.statuses[e]).show():i.hide()}var t=this,i=this.container.find(".dropdown-status"),n=this.params,r=!1;this.container.on("click keydown",".dropdown",function(e){"keydown"===e.type&&13!==e.which||(e.preventDefault(),r||t.container.toggleClass("open"),t.container.hasClass("open")&&t.container.parent().parent().find("li.library-selected").focus(),r=!0,setTimeout(function(){r=!1},400))}),this.setting.bind(e),e(this.setting())}}),u.ColorControl=u.Control.extend({ready:function(){var e=this,t=this.container.find(".color-picker-hex");t.val(e.setting()).wpColorPicker({change:function(){e.setting.set(t.wpColorPicker("color"))},clear:function(){e.setting.set(!1)}})}}),u.UploadControl=u.Control.extend({ready:function(){var t=this;this.params.removed=this.params.removed||"",this.success=h.proxy(this.success,this),this.uploader=h.extend({container:this.container,browser:this.container.find(".upload"),dropzone:this.container.find(".upload-dropzone"),success:this.success,plupload:{},params:{}},this.uploader||{}),t.params.extensions&&(t.uploader.plupload.filters=[{title:u.l10n.allowedFiles,extensions:t.params.extensions}]),t.params.context&&(t.uploader.params["post_data[context]"]=this.params.context),u.settings.theme.stylesheet&&(t.uploader.params["post_data[theme]"]=u.settings.theme.stylesheet),this.uploader=new wp.Uploader(this.uploader),this.remover=this.container.find(".remove"),this.remover.on("click keydown",function(e){"keydown"===e.type&&13!==e.which||(t.setting.set(t.params.removed),e.preventDefault())}),this.removerVisibility=h.proxy(this.removerVisibility,this),this.setting.bind(this.removerVisibility),this.removerVisibility(this.setting.get())},success:function(e){this.setting.set(e.get("url"))},removerVisibility:function(e){this.remover.toggle(e!=this.params.removed)}}),u.ImageControl=u.UploadControl.extend({ready:function(){var n,r=this;this.uploader={init:function(){var e,t;this.supports.dragdrop||(t=(e=r.container.find(".upload-fallback")).children().detach(),this.browser.detach().empty().append(t),e.append(this.browser).show())}},u.UploadControl.prototype.ready.call(this),this.thumbnail=this.container.find(".preview-thumbnail img"),this.thumbnailSrc=h.proxy(this.thumbnailSrc,this),this.setting.bind(this.thumbnailSrc),this.library=this.container.find(".library"),this.tabs={},n=this.library.find(".library-content"),this.library.children("ul").children("li").each(function(){var e=h(this),t=e.data("customizeTab"),i=n.filter('[data-customize-tab="'+t+'"]');r.tabs[t]={both:e.add(i),link:e,panel:i}}),this.library.children("ul").on("click keydown","li",function(e){var t;"keydown"===e.type&&13!==e.which||(t=h(this).data("customizeTab"),t=r.tabs[t],e.preventDefault(),t.link.hasClass("library-selected")||(r.selected.both.removeClass("library-selected"),r.selected=t,r.selected.both.addClass("library-selected")))}),this.library.on("click keydown","a",function(e){var t;"keydown"===e.type&&13!==e.which||(t=h(this).data("customizeImageValue"))&&(r.setting.set(t),e.preventDefault())}),this.tabs.uploaded&&(this.tabs.uploaded.target=this.library.find(".uploaded-target"),this.tabs.uploaded.panel.find(".thumbnail").length||this.tabs.uploaded.both.addClass("hidden")),n.each(function(){var e=r.tabs[h(this).data("customizeTab")];if(!e.link.hasClass("hidden"))return(r.selected=e).both.addClass("library-selected"),!1}),this.dropdownInit()},success:function(e){u.UploadControl.prototype.success.call(this,e),this.tabs.uploaded&&this.tabs.uploaded.target.length&&(this.tabs.uploaded.both.removeClass("hidden"),e.element=h('<a href="#" class="thumbnail"></a>').data("customizeImageValue",e.get("url")).append('<img src="'+e.get("url")+'" />').appendTo(this.tabs.uploaded.target))},thumbnailSrc:function(e){/^(https?:)?\/\//.test(e)?this.thumbnail.prop("src",e).show():this.thumbnail.hide()}}),u.HeaderControl=u.Control.extend({ready:function(){this.btnRemove=h("#customize-control-header_image .actions .remove"),this.btnNew=h("#customize-control-header_image .actions .new"),_.bindAll(this,"openMedia","removeImage"),this.btnNew.on("click",this.openMedia),this.btnRemove.on("click",this.removeImage),u.HeaderTool.currentHeader=new u.HeaderTool.ImageModel,new u.HeaderTool.CurrentView({model:u.HeaderTool.currentHeader,el:".current .container"}),new u.HeaderTool.ChoiceListView({collection:u.HeaderTool.UploadsList=new u.HeaderTool.ChoiceList,el:".choices .uploaded .list"}),new u.HeaderTool.ChoiceListView({collection:u.HeaderTool.DefaultsList=new u.HeaderTool.DefaultsList,el:".choices .default .list"}),u.HeaderTool.combinedList=u.HeaderTool.CombinedList=new u.HeaderTool.CombinedList([u.HeaderTool.UploadsList,u.HeaderTool.DefaultsList])},calculateImageSelectOptions:function(e,t){var i=parseInt(_wpCustomizeHeader.data.width,10),n=parseInt(_wpCustomizeHeader.data.height,10),r=!!parseInt(_wpCustomizeHeader.data["flex-width"],10),s=!!parseInt(_wpCustomizeHeader.data["flex-height"],10),o=e.get("width"),e=e.get("height");return this.headerImage=new u.HeaderTool.ImageModel,this.headerImage.set({themeWidth:i,themeHeight:n,themeFlexWidth:r,themeFlexHeight:s,imageWidth:o,imageHeight:e}),t.set("canSkipCrop",!this.headerImage.shouldBeCropped()),(t=i/n)<o/e?i=(n=e)*t:n=(i=o)/t,!(e={handles:!0,keys:!0,instance:!0,persistent:!0,imageWidth:o,imageHeight:e,x1:0,y1:0,x2:i,y2:n})==s&&!1==r&&(e.aspectRatio=i+":"+n),!1==s&&(e.maxHeight=n),!1==r&&(e.maxWidth=i),e},openMedia:function(e){var t=_wpMediaViewsL10n;e.preventDefault(),this.frame=wp.media({button:{text:t.selectAndCrop,close:!1},states:[new wp.media.controller.Library({title:t.chooseImage,library:wp.media.query({type:"image"}),multiple:!1,priority:20,suggestedWidth:_wpCustomizeHeader.data.width,suggestedHeight:_wpCustomizeHeader.data.height}),new wp.media.controller.Cropper({imgSelectOptions:this.calculateImageSelectOptions})]}),this.frame.on("select",this.onSelect,this),this.frame.on("cropped",this.onCropped,this),this.frame.on("skippedcrop",this.onSkippedCrop,this),this.frame.open()},onSelect:function(){this.frame.setState("cropper")},onCropped:function(e){var t=e.post_content,i=e.attachment_id,n=e.width,e=e.height;this.setImageFromURL(t,i,n,e)},onSkippedCrop:function(e){var t=e.get("url"),i=e.get("width"),n=e.get("height");this.setImageFromURL(t,e.id,i,n)},setImageFromURL:function(e,t,i,n){var r={};r.url=e,r.thumbnail_url=e,r.timestamp=_.now(),t&&(r.attachment_id=t),i&&(r.width=i),n&&(r.height=n),e=new u.HeaderTool.ImageModel({header:r,choice:e.split("/").pop()}),u.HeaderTool.UploadsList.add(e),u.HeaderTool.currentHeader.set(e.toJSON()),e.save(),e.importImage()},removeImage:function(){u.HeaderTool.currentHeader.trigger("hide"),u.HeaderTool.CombinedList.trigger("control:removeImage")}}),u.defaultConstructor=u.Setting,u.control=new u.Values({defaultConstructor:u.Control}),u.PreviewFrame=u.Messenger.extend({sensitivity:2e3,initialize:function(e,t){var i=h.Deferred();i.promise(this),this.container=e.container,this.signature=e.signature,h.extend(e,{channel:u.PreviewFrame.uuid()}),u.Messenger.prototype.initialize.call(this,e,t),this.add("previewUrl",e.previewUrl),this.query=h.extend(e.query||{},{customize_messenger_channel:this.channel()}),this.run(i)},run:function(n){var r=this,s=!1,o=!1;this._ready&&this.unbind("ready",this._ready),this._ready=function(){o=!0,s&&n.resolveWith(r)},this.bind("ready",this._ready),this.bind("ready",function(e){e&&e.activeControls&&h.each(e.activeControls,function(e,t){e=u.control(e);e&&e.active(t)})}),this.request=h.ajax(this.previewUrl(),{type:"POST",data:this.query,xhrFields:{withCredentials:!0}}),this.request.fail(function(){n.rejectWith(r,["request failure"])}),this.request.done(function(e){var t=r.request.getResponseHeader("Location"),i=r.signature;t&&t!=r.previewUrl()?n.rejectWith(r,["redirect",t]):"0"!==e?"-1"!==e?-1===(t=e.lastIndexOf(i))||t<e.lastIndexOf("</html>")?n.rejectWith(r,["unsigned"]):(e=e.slice(0,t)+e.slice(t+i.length),r.iframe=h("<iframe />").appendTo(r.container),r.iframe.one("load",function(){s=!0,o?n.resolveWith(r):setTimeout(function(){n.rejectWith(r,["ready timeout"])},r.sensitivity)}),r.targetWindow(r.iframe[0].contentWindow),r.targetWindow().document.open(),r.targetWindow().document.write(e),r.targetWindow().document.close()):n.rejectWith(r,["cheatin"]):r.login(n)})},login:function(i){var n=this,r=function(){i.rejectWith(n,["logged out"])};if(this.triedLogin)return r();h.get(u.settings.url.ajax,{action:"logged-in"}).fail(r).done(function(e){var t;"1"!==e&&r(),(t=h('<iframe src="'+n.previewUrl()+'" />').hide()).appendTo(n.container),t.load(function(){n.triedLogin=!0,t.remove(),n.run(i)})})},destroy:function(){u.Messenger.prototype.destroy.call(this),this.request.abort(),this.iframe&&this.iframe.remove(),delete this.request,delete this.iframe,delete this.targetWindow}}),e=0,u.PreviewFrame.uuid=function(){return"preview-"+e++},u.Previewer=u.Messenger.extend({refreshBuffer:250,initialize:function(e,t){var i,n,r,s=this,o=/^https?/;function a(){n=null,r.call(i)}h.extend(this,t||{}),this.refresh=(r=(i=this).refresh,function(){if("number"!=typeof n){if(!i.loading)return a();i.abort()}clearTimeout(n),n=setTimeout(a,i.refreshBuffer)}),this.container=u.ensure(e.container),this.allowedUrls=e.allowedUrls,this.signature=e.signature,e.url=window.location.href,u.Messenger.prototype.initialize.call(this,e),this.add("scheme",this.origin()).link(this.origin).setter(function(e){e=e.match(o);return e?e[0]:""}),this.add("previewUrl",e.previewUrl).setter(function(e){var r;return/\/wp-admin(\/|$)/.test(e.replace(/[#?].*$/,""))?null:(h.each([e.replace(o,s.scheme()),e],function(e,n){if(h.each(s.allowedUrls,function(e,t){var i;if(t=t.replace(/\/+$/,""),i=n.replace(t,""),0===n.indexOf(t)&&/^([/#?]|$)/.test(i))return r=n,!1}),r)return!1}),r||null)}),this.previewUrl.bind(this.refresh),this.scroll=0,this.bind("scroll",function(e){this.scroll=e}),this.bind("url",this.previewUrl)},query:function(){},abort:function(){this.loading&&(this.loading.destroy(),delete this.loading)},refresh:function(){var i=this;this.abort(),this.loading=new u.PreviewFrame({url:this.url(),previewUrl:this.previewUrl(),query:this.query()||{},container:this.container,signature:this.signature}),this.loading.done(function(){this.bind("synced",function(){i.preview&&i.preview.destroy(),i.preview=this,delete i.loading,i.targetWindow(this.targetWindow()),i.channel(this.channel()),i.send("active")}),this.send("sync",{scroll:i.scroll,settings:u.get()})}),this.loading.fail(function(e,t){"redirect"===e&&t&&i.previewUrl(t),"logged out"===e&&(i.preview&&(i.preview.destroy(),delete i.preview),i.login().done(i.refresh)),"cheatin"===e&&i.cheatin()})},login:function(){var e,t,i,n=this;return this._login||(e=h.Deferred(),this._login=e.promise(),t=new u.Messenger({channel:"login",url:u.settings.url.login}),i=h('<iframe src="'+u.settings.url.login+'" />').appendTo(this.container),t.targetWindow(i[0].contentWindow),t.bind("login",function(){i.remove(),t.destroy(),delete n._login,e.resolve()}),this._login)},cheatin:function(){h(document.body).empty().addClass("cheatin").append("<p>"+u.l10n.cheatin+"</p>")}}),u.controlConstructor={color:u.ColorControl,upload:u.UploadControl,image:u.ImageControl,header:u.HeaderControl},h(function(){if(u.settings=window._wpCustomizeSettings,u.l10n=window._wpCustomizeControlsL10n,u.settings){if(!h.support.postMessage||!h.support.cors&&u.settings.isCrossDomain)return window.location=u.settings.url.fallback;var i,e,t,n,r,s,o=h(document.body),a=o.children(".wp-full-overlay"),l=h("#customize-info .theme-name.site-title"),c=h(".customize-controls-close"),d=h("#save");h("#customize-controls").on("keydown",function(e){var t=13===e.which,i=h(e.target);t&&(i.is("input:not([type=button])")||i.is("select"))&&e.preventDefault()}),u.previewer=new u.Previewer({container:"#customize-preview",form:"#customize-controls",previewUrl:u.settings.url.preview,allowedUrls:u.settings.url.allowed,signature:"WP_CUSTOMIZER_SIGNATURE"},{nonce:u.settings.nonce,query:function(){return{wp_customize:"on",theme:u.settings.theme.stylesheet,customized:JSON.stringify(u.get()),nonce:this.nonce.preview}},save:function(){var e,t,i=this,n=h.extend(this.query(),{action:"customize_save",nonce:this.nonce.save}),r=u.state("processing");o.addClass("saving"),t=function(){var e=h.post(u.settings.url.ajax,n);u.trigger("save",e),e.always(function(){o.removeClass("saving")}),e.done(function(e){return"0"===e?(i.preview.iframe.hide(),void i.login().done(function(){i.save(),i.preview.iframe.show()})):void("-1"!==e?u.trigger("saved"):i.cheatin())})},0===r()?t():(e=function(){0===r()&&(u.state.unbind("change",e),t())},u.state.bind("change",e))}}),h.ajaxPrefilter(function(e){/wp_customize=on/.test(e.data)&&(e.data+="&"+h.param({customize_preview_nonce:u.settings.nonce.preview}))}),u.previewer.bind("nonce",function(e){h.extend(this.nonce,e)}),h.each(u.settings.settings,function(e,t){u.create(e,e,t.value,{transport:t.transport,previewer:u.previewer})}),h.each(u.settings.controls,function(e,t){var i=u.controlConstructor[t.type]||u.Control;u.control.add(e,new i(e,{params:t,previewer:u.previewer}))}),u.previewer.previewUrl()?u.previewer.refresh():u.previewer.previewUrl(u.settings.url.home),t=new u.Values,n=t.create("saved"),r=t.create("activated"),s=t.create("processing"),t.bind("change",function(){r()?n()?(d.val(u.l10n.saved).prop("disabled",!0),c.find(".screen-reader-text").text(u.l10n.close)):(d.val(u.l10n.save).prop("disabled",!1),c.find(".screen-reader-text").text(u.l10n.cancel)):(d.val(u.l10n.activate).prop("disabled",!1),c.find(".screen-reader-text").text(u.l10n.cancel))}),n(!0),r(u.settings.theme.active),s(0),u.bind("change",function(){t("saved").set(!1)}),u.bind("saved",function(){t("saved").set(!0),t("activated").set(!0)}),r.bind(function(e){e&&u.trigger("activated")}),u.state=t,d.click(function(e){u.previewer.save(),e.preventDefault()}).keydown(function(e){9!==e.which&&(13===e.which&&u.previewer.save(),e.preventDefault())}),c.keydown(function(e){9!==e.which&&(13===e.which&&this.click(),e.preventDefault())}),h(".upload-dropzone a.upload").keydown(function(e){13===e.which&&this.click()}),h(".collapse-sidebar").on("click keydown",function(e){"keydown"===e.type&&13!==e.which||(a.toggleClass("collapsed").toggleClass("expanded"),e.preventDefault())}),l.length&&h("#customize-control-blogname input").on("input",function(){l.text(this.value)}),(i=new u.Messenger({url:u.settings.url.parent,channel:"loader"})).bind("back",function(){c.on("click.customize-controls-close",function(e){e.preventDefault(),i.send("close")})}),h(window).on("beforeunload",function(){if(!u.state("saved")())return u.l10n.saveAlert}),h.each(["saved","change"],function(e,t){u.bind(t,function(){i.send(t)})}),u.bind("activated",function(){i.targetWindow()?i.send("activated",u.settings.url.activated):u.settings.url.activated&&(window.location=u.settings.url.activated)}),i.send("ready"),h.each({background_image:{controls:["background_repeat","background_position_x","background_attachment"],callback:function(e){return!!e}},show_on_front:{controls:["page_on_front","page_for_posts"],callback:function(e){return"page"===e}},header_textcolor:{controls:["header_textcolor"],callback:function(e){return"blank"!==e}}},function(e,n){u(e,function(i){h.each(n.controls,function(e,t){u.control(t,function(t){function e(e){t.container.toggle(n.callback(e))}e(i.get()),i.bind(e)})})})}),u.control("display_header_text",function(t){var i="";t.elements[0].unsync(u("header_textcolor")),t.element=new u.Element(t.container.find("input")),t.element.set("blank"!==t.setting()),t.element.bind(function(e){e||(i=u("header_textcolor").get()),t.setting.set(e?i:"blank")}),t.setting.bind(function(e){t.element.set("blank"!==e)})}),u.trigger("ready"),(e=c).focus(),setTimeout(function(){e.focus()},200)}})}((wp,jQuery));