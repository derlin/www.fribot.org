tinymce.PluginManager.add("wpeditimage",function(g){var t,s=!1,l=!1;function e(e){return e.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(e,t,a){var n,i,o,c,d,s=tinymce.trim,l=t.match(/id=['"]([^'"]*)['"] ?/);return(d=(t=(i=(t=(n=(t=l?t.replace(l[0],""):t).match(/align=['"]([^'"]*)['"] ?/))?t.replace(n[0],""):t).match(/class=['"]([^'"]*)['"] ?/))?t.replace(i[0],""):t).match(/width=['"]([0-9]*)['"] ?/))&&(t=t.replace(d[0],"")),c=(c=(a=s(a)).match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&c[2]?(o=s(c[2]),s(c[1])):(o=s(t).replace(/caption=['"]/,"").replace(/['"]$/,""),a),l=l&&l[1]?l[1].replace(/[<>&]+/g,""):"",n=n&&n[1]?n[1]:"alignnone",i=i&&i[1]?" "+i[1].replace(/[<>&]+/g,""):"",(d=(d=!d&&c?c.match(/width=['"]([0-9]*)['"]/):d)&&d[1]?d[1]:d)&&o?(d=parseInt(d,10),g.getParam("wpeditimage_html5_captions")||(d+=10),'<div class="mceTemp"><dl id="'+l+'" class="wp-caption '+n+i+'" style="width: '+d+'px"><dt class="wp-caption-dt">'+c+'</dt><dd class="wp-caption-dd">'+o+"</dd></dl></div>"):a})}function a(e){return e.replace(/<div (?:id="attachment_|class="mceTemp)[^>]*>([\s\S]+?)<\/div>/g,function(e,t){var a="";return-1===t.indexOf("<img ")?(a=t.match(/<dd [^>]+>([\s\S]+?)<\/dd>/i))&&a[1]?"<p>"+a[1]+"</p>":"":-1===(a=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(e,t,a,n){var i,o=a.match(/width="([0-9]*)"/);return(o=o&&o[1]?o[1]:"")&&n?'[caption id="'+(i=(i=t.match(/id="([^"]*)"/))&&i[1]?i[1]:"")+'" align="'+((t=(t=t.match(/class="([^"]*)"/))&&t[1]?t[1]:"").match(/align[a-z]+/i)||"alignnone")+'" width="'+o+'"'+(t=(t=t.replace(/wp-caption ?|align[a-z]+ ?/gi,""))&&' class="'+t+'"')+"]"+a+" "+(n=(n=n.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/\s*\n\s*/g,"<br />"))+"[/caption]":a})).indexOf("[caption")?t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2"):a})}function m(e){return e&&(e.textContent||e.innerText)}function u(e){return!e||-1===e.indexOf("<")&&-1===e.indexOf(">")?e:(t=t||new tinymce.html.Serializer({},g.schema)).serialize(g.parser.parse(e,{forced_root_block:!1}))}function i(p){var e,t,a,n,i,o,c,d,s;"undefined"!=typeof wp&&wp.media?(t=p,o=[],c=g.dom,(s={attachment_id:!(d=/^\d+$/),size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""}).url=c.getAttrib(t,"src"),s.alt=c.getAttrib(t,"alt"),s.title=c.getAttrib(t,"title"),n=c.getAttrib(t,"width"),i=c.getAttrib(t,"height"),(!d.test(n)||parseInt(n,10)<1)&&(n=t.naturalWidth||t.width),(!d.test(i)||parseInt(i,10)<1)&&(i=t.naturalHeight||t.height),s.customWidth=s.width=n,s.customHeight=s.height=i,n=tinymce.explode(t.className," "),a=[],tinymce.each(n,function(e){/^wp-image/.test(e)?s.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?s.align=e.replace("align",""):/^size/.test(e)?s.size=e.replace("size-",""):a.push(e)}),s.extraClasses=a.join(" "),(i=c.getParents(t,".wp-caption")).length&&(n=(i=i[0]).className.split(" "),tinymce.each(n,function(e){/^align/.test(e)?s.align=e.replace("align",""):e&&"wp-caption"!==e&&o.push(e)}),s.captionClassName=o.join(" "),(i=c.select("dd.wp-caption-dd",i)).length&&(i=i[0],s.caption=g.serializer.serialize(i).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))),t.parentNode&&"A"===t.parentNode.nodeName&&(t=t.parentNode,s.linkUrl=c.getAttrib(t,"href"),s.linkTargetBlank="_blank"===c.getAttrib(t,"target"),s.linkRel=c.getAttrib(t,"rel"),s.linkClassName=t.className),t=s,wp.media.events.trigger("editor:image-edit",{editor:g,metadata:t,image:p}),e=wp.media({frame:"image",state:"image-details",metadata:t}),wp.media.events.trigger("editor:frame-create",{frame:e}),t=function(r){g.focus(),g.undoManager.transact(function(){var e,t,a,n,i,o,c,d,s,l;e=p,t=r,s=g.dom,l=(l=tinymce.explode(t.extraClasses," "))||[],t.caption||l.push("align"+t.align),t.attachment_id&&(l.push("wp-image-"+t.attachment_id),t.size&&"custom"!==t.size&&l.push("size-"+t.size)),c=t.width,d=t.height,"custom"===t.size&&(c=t.customWidth,d=t.customHeight),i={src:t.url,width:c||null,height:d||null,alt:t.alt,title:t.title||null,"class":l.join(" ")||null},s.setAttribs(e,i),o={href:t.linkUrl,rel:t.linkRel||null,target:t.linkTargetBlank?"_blank":null,"class":t.linkClassName||null},e.parentNode&&"A"===e.parentNode.nodeName&&!m(e.parentNode)?t.linkUrl?s.setAttribs(e.parentNode,o):s.remove(e.parentNode,!0):t.linkUrl&&((n=s.getParent(e,"a"))&&s.insertAfter(e,n),n=s.create("a",o),e.parentNode.insertBefore(n,e),n.appendChild(e)),d=g.dom.getParent(e,".mceTemp"),l=e.parentNode&&"A"===e.parentNode.nodeName&&!m(e.parentNode)?e.parentNode:e,t.caption?(t.caption=u(t.caption),i=t.attachment_id?"attachment_"+t.attachment_id:null,o="wp-caption "+("align"+(t.align||"none")),t.captionClassName&&(o+=" "+t.captionClassName.replace(/[<>&]+/g,"")),g.getParam("wpeditimage_html5_captions")||(c=parseInt(c,10),c+=10),d?((n=s.select("dl.wp-caption",d)).length&&s.setAttribs(n,{id:i,"class":o,style:"width: "+c+"px"}),(n=s.select(".wp-caption-dd",d)).length&&s.setHTML(n[0],t.caption)):(o="<dl "+(i=i?'id="'+i+'" ':"")+'class="'+o+'" style="width: '+c+'px"><dt class="wp-caption-dt">'+s.getOuterHTML(l)+'</dt><dd class="wp-caption-dd">'+t.caption+"</dd></dl>",(a=s.getParent(l,"p"))?(c=s.create("div",{"class":"mceTemp"},o),a.parentNode.insertBefore(c,a),s.remove(l),s.isEmpty(a)&&s.remove(a)):s.setOuterHTML(l,'<div class="mceTemp">'+o+"</div>"))):d&&(a=s.create("p"),d.parentNode.insertBefore(a,d),a.appendChild(l),s.remove(d)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:g,metadata:t,image:e}),g.nodeChanged(),h(e)}),e.detach()},e.state("image-details").on("update",t),e.state("replace-image").on("replace",t),e.on("close",function(){g.focus(),e.detach(),l=!1}),e.open()):g.execCommand("mceImage")}function r(e){var t;"DIV"===e.nodeName&&g.dom.hasClass(e,"mceTemp")?t=e:"IMG"!==e.nodeName&&"DT"!==e.nodeName&&"A"!==e.nodeName||(t=g.dom.getParent(e,"div.mceTemp")),t?(t.nextSibling?g.selection.select(t.nextSibling):t.previousSibling?g.selection.select(t.previousSibling):g.selection.select(t.parentNode),g.selection.collapse(!0),g.dom.remove(t)):g.dom.remove(e),p(),g.nodeChanged(),g.undoManager.add()}function h(e){var t,a,n=g.dom;p(),e&&"IMG"===e.nodeName&&!o(e)&&(n.setAttrib(e,"data-wp-imgselect",1),t=n.getRect(e),a=n.create("p",{id:"wp-image-toolbar","data-mce-bogus":"all",contenteditable:!1},'<i class="dashicons dashicons-edit edit" data-mce-bogus="all"></i><i class="dashicons dashicons-no-alt remove" data-mce-bogus="all"></i>'),e=g.rtl?t.x+t.w-82:t.x,g.getBody().appendChild(a),n.setStyles(a,{top:t.y,left:e}),s=!0)}function p(){var e=g.dom.get("wp-image-toolbar");e&&g.dom.remove(e),g.dom.setAttrib(g.dom.select("img[data-wp-imgselect]"),"data-wp-imgselect",null),s=l=!1}function o(e){var t=g.dom;return!!(t.hasClass(e,"mceItem")||t.getAttrib(e,"data-mce-placeholder")||t.getAttrib(e,"data-mce-object"))}function c(e){return e&&"I"===e.nodeName&&"wp-image-toolbar"===e.parentNode.id}return"ontouchend"in document&&g.on("click",function(e){var t=e.target;l&&"IMG"===t.nodeName&&e.preventDefault(),c(t)&&(e.preventDefault(),e.stopPropagation())}),g.on("mouseup touchend",function(e){var t,a=e.target,n=g.dom;e.button&&1<e.button||(c(a)?((t=n.select("img[data-wp-imgselect]")[0])&&(g.selection.select(t),n.hasClass(a,"remove")?r(t):n.hasClass(a,"edit")&&(l||(i(t),l=!0))),e.preventDefault()):"IMG"!==a.nodeName||g.dom.getAttrib(a,"data-wp-imgselect")||o(a)?"IMG"!==a.nodeName&&p():h(a))}),g.on("init",function(){var m=g.dom,e=g.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";m.addClass(g.getBody(),e),g.on("wpLoadImageForm",function(e){g.getParam("wpeditimage_disable_captions")||e.data.splice(e.data.length-1,0,{type:"textbox",flex:1,name:"caption",minHeight:60,multiline:!0,scroll:!0,label:"Image caption"})}),g.on("wpNewImageRefresh",function(e){var t;(t=m.getParent(e.node,"dl.wp-caption"))&&(t.style.width||(e=(e=parseInt(e.node.clientWidth,10)+10)?e+"px":"50%",m.setStyle(t,"width",e)))}),g.on("wpImageFormSubmit",function(e){var t,a,n,i,o,c=e.imgData.data,d=e.imgData.node,s=e.imgData.caption,l="",r="",p="";c.id="__wp-temp-img-id",e.imgData.cancel=!0,c.style||(c.style=null),c.src?(s=s&&u(s=(s=s.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />")),d?(o=d.id||null,m.setAttribs(d,c),t=m.getParent(d,"dl.wp-caption"),s?t?(a=m.select("dd.wp-caption-dd",t)[0])&&(a.innerHTML=s):(d.className&&(l=d.className.match(/wp-image-([0-9]+)/),r=d.className.match(/align(left|right|center|none)/)),r?(r=r[0],d.className=d.className.replace(/align(left|right|center|none)/g,"")):r="alignnone",r=' class="wp-caption '+r+'"',l=l&&' id="attachment_'+l[1]+'"',(p=c.width||d.clientWidth)&&(p=parseInt(p,10),g.getParam("wpeditimage_html5_captions")||(p+=10),p=' style="width: '+p+'px"'),n=d.parentNode&&"A"===d.parentNode.nodeName?(i=m.getOuterHTML(d.parentNode),d.parentNode):(i=m.getOuterHTML(d),d),i="<dl "+l+r+p+'><dt class="wp-caption-dt">'+i+'</dt><dd class="wp-caption-dd">'+s+"</dd></dl>",(a=m.getParent(d,"p"))?(t=m.create("div",{"class":"mceTemp"},i),m.insertAfter(t,a),g.selection.select(t),g.nodeChanged(),m.remove(n),m.isEmpty(a)&&m.remove(a)):g.selection.setContent('<div class="mceTemp">'+i+"</div>")):t&&(i="A"===d.parentNode.nodeName?m.getOuterHTML(d.parentNode):m.getOuterHTML(d),a=m.create("p",{},i),m.insertAfter(a,t.parentNode),g.selection.select(a),g.nodeChanged(),m.remove(t.parentNode))):(i=m.createHTML("img",c),s?(n=g.selection.getNode(),c.width&&(p=parseInt(c.width,10),g.getParam("wpeditimage_html5_captions")||(p+=10),p=' style="width: '+p+'px"'),i='<dl class="wp-caption alignnone"'+p+'><dt class="wp-caption-dt">'+i+'</dt><dd class="wp-caption-dd">'+s+"</dd></dl>",(a="P"===n.nodeName?n:m.getParent(n,"p"))&&"P"===a.nodeName?(t=m.create("div",{"class":"mceTemp"},i),a.parentNode.insertBefore(t,a),g.selection.select(t),g.nodeChanged(),m.isEmpty(a)&&m.remove(a)):g.selection.setContent('<div class="mceTemp">'+i+"</div>")):g.selection.setContent(i)),d=m.get("__wp-temp-img-id"),m.setAttrib(d,"id",o),e.imgData.node=d):d&&((t=m.getParent(d,"div.mceTemp"))?m.remove(t):"A"===d.parentNode.nodeName?m.remove(d.parentNode):m.remove(d),g.nodeChanged())}),g.on("wpLoadImageData",function(e){var t=e.imgData.data,e=e.imgData.node;(e=m.getParent(e,"dl.wp-caption"))&&(e=m.select("dd.wp-caption-dd",e)[0])&&(t.caption=g.serializer.serialize(e).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))}),m.bind(g.getDoc(),"dragstart",function(e){var t=g.selection.getNode();"IMG"===t.nodeName&&m.getParent(t,".wp-caption")&&e.preventDefault(),p()}),tinymce.Env.ie&&10<tinymce.Env.ie&&(m.bind(g.getBody(),"mscontrolselect",function(e){"IMG"===e.target.nodeName&&m.getParent(e.target,".wp-caption")?g.getBody().focus():"DL"===e.target.nodeName&&m.hasClass(e.target,"wp-caption")&&e.target.focus()}),g.on("click",function(e){"IMG"===e.target.nodeName&&m.getAttrib(e.target,"data-wp-imgselect")&&m.getParent(e.target,"dl.wp-caption")&&g.getBody().focus()}))}),g.on("ObjectResized",function(n){var i=n.target;"IMG"===i.nodeName&&g.undoManager.transact(function(){var e,t,a=g.dom;i.className=i.className.replace(/\bsize-[^ ]+/,""),(e=a.getParent(i,".wp-caption"))&&(t=n.width||a.getAttrib(i,"width"))&&(t=parseInt(t,10),g.getParam("wpeditimage_html5_captions")||(t+=10),a.setStyle(e,"width",t+"px")),h(i)})}),g.on("BeforeExecCommand",function(e){var t,a,n=e.command,i=g.dom;"mceInsertContent"===n?(t=i.getParent(g.selection.getNode(),"div.mceTemp"))&&(a=i.create("p"),i.insertAfter(a,t),g.selection.setCursorLocation(a,0),g.nodeChanged()):"JustifyLeft"!==n&&"JustifyRight"!==n&&"JustifyCenter"!==n||(t=g.selection.getNode(),a="align"+n.substr(7).toLowerCase(),n=i.getParent(t,"dl.wp-caption"),p(),n&&(i.hasClass(n,a)?(i.removeClass(n,a),i.addClass(n,"alignnone")):(n.className=n.className.replace(/align[^ ]+/g,""),i.addClass(n,a)),"IMG"===t.nodeName&&g.nodeChanged(),e.preventDefault()),"IMG"===t.nodeName&&(i.hasClass(t,a)?i.addClass(t,"alignnone"):i.removeClass(t,"alignnone")))}),g.on("keydown",function(e){var t,a,n,i=g.selection,o=e.keyCode,c=g.dom,d=tinymce.util.VK;if(o===d.ENTER)t=i.getNode(),(a=c.getParent(t,"div.mceTemp"))&&(c.events.cancel(e),tinymce.each(c.select("dt, dd",a),function(e){c.isEmpty(e)&&c.remove(e)}),n=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',n=c.create("p",null,n),"DD"===t.nodeName?c.insertAfter(n,a):a.parentNode.insertBefore(n,a),g.nodeChanged(),i.setCursorLocation(n,0));else if(o===d.DELETE||o===d.BACKSPACE){if("DIV"===(t=i.getNode()).nodeName&&c.hasClass(t,"mceTemp")?a=t:"IMG"!==t.nodeName&&"DT"!==t.nodeName&&"A"!==t.nodeName||(a=c.getParent(t,"div.mceTemp")),a)return c.events.cancel(e),r(t),!1;p()}s&&(e.ctrlKey||e.metaKey||e.altKey||o<48&&o!==d.SPACEBAR||p())}),g.on("mousedown",function(e){c(e.target)?tinymce.Env.ie&&e.preventDefault():"IMG"!==e.target.nodeName&&p()}),g.on("BeforeAddUndo",function(e){e.level.content=e.level.content.replace(/ data-wp-imgselect="1"/g,"")}),tinymce.Env.gecko&&g.on("undo redo",function(){"IMG"===g.selection.getNode().nodeName&&g.selection.collapse()}),g.on("cut wpview-selected",function(){p()}),g.wpSetImgCaption=e,g.wpGetImgCaption=a,g.on("BeforeSetContent",function(e){"raw"!==e.format&&(e.content=g.wpSetImgCaption(e.content))}),g.on("PostProcess",function(e){e.get&&(e.content=g.wpGetImgCaption(e.content),e.content=e.content.replace(/ data-wp-imgselect="1"/g,""))}),{_do_shcode:e,_get_shcode:a}});