var wpLink;!function(l){var n,t,e,i,r={},s={},a="ontouchend"in document;wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",init:function(){r.wrap=l("#wp-link-wrap"),r.dialog=l("#wp-link"),r.backdrop=l("#wp-link-backdrop"),r.submit=l("#wp-link-submit"),r.close=l("#wp-link-close"),r.url=l("#url-field"),r.nonce=l("#_ajax_linking_nonce"),r.title=l("#link-title-field"),r.openInNewTab=l("#link-target-checkbox"),r.search=l("#search-field"),s.search=new e(l("#search-results")),s.recent=new e(l("#most-recent-results")),s.elements=r.dialog.find(".query-results"),r.queryNotice=l("#query-notice-message"),r.queryNoticeTextDefault=r.queryNotice.find(".query-notice-default"),r.queryNoticeTextHint=r.queryNotice.find(".query-notice-hint"),r.dialog.keydown(wpLink.keydown),r.dialog.keyup(wpLink.keyup),r.submit.click(function(e){e.preventDefault(),wpLink.update()}),r.close.add(r.backdrop).add("#wp-link-cancel a").click(function(e){e.preventDefault(),wpLink.close()}),l("#wp-link-search-toggle").on("click",wpLink.toggleInternalLinking),s.elements.on("river-select",wpLink.updateFields),r.search.on("focus.wplink",function(){r.queryNoticeTextDefault.hide(),r.queryNoticeTextHint.removeClass("screen-reader-text").show()}).on("blur.wplink",function(){r.queryNoticeTextDefault.show(),r.queryNoticeTextHint.addClass("screen-reader-text").hide()}),r.search.keyup(function(){var e=this;window.clearTimeout(t),t=window.setTimeout(function(){wpLink.searchInternalLinks.call(e)},500)})},open:function(e){wpLink.range=null,e&&(window.wpActiveEditor=e),window.wpActiveEditor&&(this.textarea=l("#"+window.wpActiveEditor).get(0),"undefined"!=typeof tinymce&&(e=tinymce.get(wpActiveEditor),(n=e&&!e.isHidden()?e:null)&&tinymce.isIE&&(n.windowManager.bookmark=n.selection.getBookmark())),!wpLink.isMCE()&&document.selection&&(this.textarea.focus(),this.range=document.selection.createRange()),r.wrap.show(),r.backdrop.show(),wpLink.refresh(),l(document).trigger("wplink-open",r.wrap))},isMCE:function(){return n&&!n.isHidden()},refresh:function(){s.search.refresh(),s.recent.refresh(),wpLink.isMCE()?wpLink.mceRefresh():wpLink.setDefaultValues(),a?r.url.focus().blur():r.url.focus()[0].select(),s.recent.ul.children().length||s.recent.ajax()},mceRefresh:function(){var e;(e=n.dom.getParent(n.selection.getNode(),"A"))?(r.url.val(n.dom.getAttrib(e,"href")),r.title.val(n.dom.getAttrib(e,"title")),r.openInNewTab.prop("checked","_blank"===n.dom.getAttrib(e,"target")),r.submit.val(wpLinkL10n.update)):wpLink.setDefaultValues()},close:function(){wpLink.isMCE()?n.focus():(wpLink.textarea.focus(),wpLink.range&&(wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select())),r.backdrop.hide(),r.wrap.hide(),l(document).trigger("wplink-close",r.wrap)},getAttrs:function(){return{href:r.url.val(),title:r.title.val(),target:r.openInNewTab.prop("checked")?"_blank":""}},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var e,t,i,n,r=wpLink.textarea;r&&(i=wpLink.getAttrs(),(n=document.createElement("a")).href=i.href,"javascript:"!==n.protocol&&"data:"!==n.protocol||(i.href=""),i.href&&"http://"!=i.href&&(e='<a href="'+i.href+'"',i.title&&(e+=' title="'+i.title.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")+'"'),i.target&&(e+=' rel="noopener" target="'+i.target+'"'),e+=">",document.selection&&wpLink.range?(r.focus(),wpLink.range.text=e+wpLink.range.text+"</a>",wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select(),wpLink.range=null):void 0!==r.selectionStart&&(t=r.selectionStart,n=r.selectionEnd,i=t+(e=e+r.value.substring(t,n)+"</a>").length,t==n&&(i-="</a>".length),r.value=r.value.substring(0,t)+e+r.value.substring(n,r.value.length),r.selectionStart=r.selectionEnd=i),wpLink.close(),r.focus()))},mceUpdate:function(){var e,t=wpLink.getAttrs();wpLink.close(),n.focus(),tinymce.isIE&&n.selection.moveToBookmark(n.windowManager.bookmark),e=n.dom.getParent(n.selection.getNode(),"a[href]");var i=document.createElement("a");i.href=t.href,"javascript:"!==i.protocol&&"data:"!==i.protocol||(t.href=""),t.href&&"http://"!=t.href?(e?n.dom.setAttribs(e,t):n.execCommand("mceInsertLink",!1,t),n.selection.collapse()):n.execCommand("unlink")},updateFields:function(e,t){r.url.val(t.children(".item-permalink").val()),r.title.val(t.hasClass("no-title")?"":t.children(".item-title").text())},setDefaultValues:function(){var e=n&&n.selection.getContent();e&&/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i.test(e)?r.url.val("mailto:"+e):e&&/^(https?|ftp):\/\/[A-Z0-9.-]+\.[A-Z]{2,4}[^ "]*$/i.test(e)?r.url.val(e.replace(/&amp;|&#0?38;/gi,"&")):r.url.val("http://"),r.title.val(""),r.submit.val(wpLinkL10n.save)},searchInternalLinks:function(){var e,t=l(this),i=t.val();2<i.length?(s.recent.hide(),s.search.show(),wpLink.lastSearch!=i&&(wpLink.lastSearch=i,e=t.parent().find(".spinner").show(),s.search.change(i),s.search.ajax(function(){e.hide()}))):(s.search.hide(),s.recent.show())},next:function(){s.search.next(),s.recent.next()},prev:function(){s.search.prev(),s.recent.prev()},keydown:function(e){var t,i=l.ui.keyCode;i.ESCAPE===e.keyCode?(wpLink.close(),e.stopImmediatePropagation()):i.TAB===e.keyCode&&("wp-link-submit"!==(t=e.target.id)||e.shiftKey?"wp-link-close"===t&&e.shiftKey&&(r.submit.focus(),e.preventDefault()):(r.close.focus(),e.preventDefault())),e.keyCode!==i.UP&&e.keyCode!==i.DOWN||document.activeElement&&("link-title-field"===document.activeElement.id||"url-field"===document.activeElement.id)||(i=e.keyCode===i.UP?"prev":"next",clearInterval(wpLink.keyInterval),wpLink[i](),wpLink.keyInterval=setInterval(wpLink[i],wpLink.keySensitivity),e.preventDefault())},keyup:function(e){var t=l.ui.keyCode;e.which!==t.UP&&e.which!==t.DOWN||(clearInterval(wpLink.keyInterval),e.preventDefault())},delayedCallback:function(e,t){var i,n,r,l;return t?(setTimeout(function(){return n?e.apply(l,r):void(i=!0)},t),function(){if(i)return e.apply(this,arguments);r=arguments,l=this,n=!0}):e},toggleInternalLinking:function(e){var t=r.wrap.hasClass("search-panel-visible");r.wrap.toggleClass("search-panel-visible",!t),setUserSetting("wplink",t?"0":"1"),r[t?"url":"search"].focus(),e.preventDefault()}},e=function(e,t){var i=this;this.element=e,this.ul=e.children("ul"),this.contentHeight=e.children("#link-selector-height"),this.waiting=e.find(".river-waiting"),this.change(t),this.refresh(),l("#wp-link .query-results, #wp-link #link-selector").scroll(function(){i.maybeLoad()}),e.on("click","li",function(e){i.select(l(this),e)})},l.extend(e.prototype,{refresh:function(){this.deselect(),this.visible=this.element.is(":visible")},show:function(){this.visible||(this.deselect(),this.element.show(),this.visible=!0)},hide:function(){this.element.hide(),this.visible=!1},select:function(e,t){var i,n,r,l;e.hasClass("unselectable")||e==this.selected||(this.deselect(),this.selected=e.addClass("selected"),i=e.outerHeight(),n=this.element.height(),r=e.position().top,l=this.element.scrollTop(),r<0?this.element.scrollTop(l+r):n<r+i&&this.element.scrollTop(l+r-n+i),this.element.trigger("river-select",[e,t,this]))},deselect:function(){this.selected&&this.selected.removeClass("selected"),this.selected=!1},prev:function(){var e;this.visible&&this.selected&&(e=this.selected.prev("li")).length&&this.select(e)},next:function(){var e;!this.visible||(e=this.selected?this.selected.next("li"):l("li:not(.unselectable):first",this.element)).length&&this.select(e)},ajax:function(i){var n=this,e=1==this.query.page?0:wpLink.minRiverAJAXDuration,e=wpLink.delayedCallback(function(e,t){n.process(e,t),i&&i(e,t)},e);this.query.ajax(e)},change:function(e){this.query&&this._search==e||(this._search=e,this.query=new i(e),this.element.scrollTop(0))},process:function(e,t){var i,n="",r=!0,t=1==t.page;e?l.each(e,function(){i=r?"alternate":"",i+=this.title?"":" no-title",n+=i?'<li class="'+i+'">':"<li>",n+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />',n+='<span class="item-title">',n+=this.title||wpLinkL10n.noTitle,n+='</span><span class="item-info">'+this.info+"</span></li>",r=!r}):t&&(n+='<li class="unselectable no-matches-found"><span class="item-title"><em>'+wpLinkL10n.noMatchesFound+"</em></span></li>"),this.ul[t?"html":"append"](n)},maybeLoad:function(){var i=this,n=this.element,e=n.scrollTop()+n.height();!this.query.ready()||e<this.contentHeight.height()-wpLink.riverBottomThreshold||setTimeout(function(){var e=n.scrollTop(),t=e+n.height();!i.query.ready()||t<i.contentHeight.height()-wpLink.riverBottomThreshold||(i.waiting.show(),n.scrollTop(e+i.waiting.outerHeight()),i.ajax(function(){i.waiting.hide()}))},wpLink.timeToTriggerRiver)}}),i=function(e){this.page=1,this.allLoaded=!1,this.querying=!1,this.search=e},l.extend(i.prototype,{ready:function(){return!(this.querying||this.allLoaded)},ajax:function(t){var i=this,n={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:r.nonce.val()};this.search&&(n.search=this.search),this.querying=!0,l.post(ajaxurl,n,function(e){i.page++,i.querying=!1,i.allLoaded=!e,t(e,n)},"json")}}),l(document).ready(wpLink.init)}(jQuery);